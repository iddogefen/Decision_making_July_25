<!DOCTYPE html>
<html>
  <head>
    <title>Information Value Task</title>
    <script src="jspsych/plugins/jspsych.js"></script>
    <script src="jspsych/plugins/plugin-instructions.js"></script>
    <script src="jspsych/plugins/plugin-html-button-response.js"></script>
    <script src="jspsych/plugins/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/plugin-survey-likert.js"></script>
    <script src="jspsych/plugins/plugin-fullscreen.js"></script>
    <script src="jspsych/plugins/plugin-preload.js"></script>
    <script src="jspsych/plugins/plugin-survey-text.js"></script>
    <link rel="stylesheet" href="jspsych/css/jspsych.css">
  </head>
  <body></body>

  <script>
    // ====================================================
    // SAVE FUNCTION
    // ====================================================
    var data_folder = 'data/';

    function saveData(name, data) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'write_data.php');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify({ filedata: data }));
    }

    // ====================================================
    // INIT JPSYCH
    // ====================================================
    var jsPsych = initJsPsych({
      on_finish: function() {
        saveData(
          data_folder + 'All_data/all_data_sub_' + subject_id + ".csv",
          jsPsych.data.get().csv()
        );
      }
    });

    // ====================================================
    // SUBJECT PROPERTIES (must come *after* initJsPsych)
    // ====================================================
    var subject_id = jsPsych.data.getURLVariable('participantId') || "anon_" + Math.floor(Math.random()*100000);
    var study_id   = jsPsych.data.getURLVariable('assignmentId') || "none";
    var session_id = jsPsych.data.getURLVariable('projectId') || "session_" + Date.now();

    jsPsych.data.addProperties({
      subject_id: subject_id,
      study_id: study_id,
      session_id: session_id,
    });

    // ====================================================
    // TIMELINE START
    // ====================================================
    var timeline = [];

    // ====================================================
    // PRELOAD
    // ====================================================
    var preload = {
      type: jsPsychPreload,
      images: [
        'consent_form_2022.png',
        'images/blue_deck_1.png',
        'images/red_deck_2.png'
      ]
    };
    timeline.push(preload);

    // ====================================================
    // CONSENT & INSTRUCTIONS
    // ====================================================
    var trial_intro = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-family:Arial; text-align:left; padding:80px;">' +
        '<h2>Welcome!</h2>' +
        '<p>Thank you for participating in this study. You will make decisions about whether to view or wait for pieces of information.</p>' +
        '<p>Press "Next" to continue.</p></div>'
      ],
      show_clickable_nav: true
    };

    var trial_consent = {
      type: jsPsychInstructions,
      pages: [
        '<div style="text-align:center;">' +
        '<h3>Please read the consent form carefully before proceeding.</h3>' +
        '<img src="consent_form_2022.png" style="max-width:80%; padding:20px;"></img>' +
        '</div>'
      ],
      show_clickable_nav: true
    };

    var trial_fullscreen = {
      type: jsPsychFullscreen,
      fullscreen_mode: true
    };

    var instructions_main = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-family:Arial; text-align:left; padding:100px;">' +
        '<h2>Instructions</h2>' +
        '<p>In each round, you will first see an initial card showing an interesting fact.</p>' +
        '<p>Then, one of two decks will be randomly offered:</p>' +
        '<ul>' +
        '<li><span style="color:blue;">Blue deck</span>: shows two related facts connected to the first card.</li>' +
        '<li><span style="color:red;">Red deck</span>: shows two unrelated facts from different topics.</li>' +
        '</ul>' +
        '<p>If you choose to <b>view</b>, you will lose 1, 3, or 5 cents randomly.</p>' +
        '<p>If you choose to <b>wait</b>, you will not lose money but will see a waiting screen for the same time.</p>' +
        '<p>Each round lasts the same time, whether you view or wait.</p>' +
        '<p>You get a $1 bonus, reduced by the total amount you spent to view information.</p>' +
        '</div>'
      ],
      show_clickable_nav: true
    };

    timeline.push(trial_intro, trial_consent, trial_fullscreen, instructions_main);

    // ====================================================
    // HELPER FUNCTION
    // ====================================================
    function createImageTrial(imagePath, label, duration = 6000) {
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div style="display:flex;justify-content:center;align-items:center;">
                     <img src="${imagePath}" style="width:300px;height:300px;">
                   </div>`,
        choices: "NO_KEYS",
        trial_duration: duration,
        data: { phase: label }
      };
    }

    // ====================================================
    // MAIN TRIAL FUNCTION
    // ====================================================
    function createDeckTrial(seriesIndex) {
      return {
        timeline: [
          createImageTrial(`images/causal/causal_series_${seriesIndex}/causal_series_${seriesIndex}_a.png`, 'start', 6000),

          {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
              const color = jsPsych.randomization.sampleWithoutReplacement(["red", "blue"], 1)[0];
              const cost = jsPsych.randomization.sampleWithoutReplacement([1, 3, 5], 1)[0];
              jsPsych.data.addProperties({ offered_color: color, view_cost: cost });

              const reminder = color === "blue"
                ? "The blue deck shows two related facts."
                : "The red deck shows two unrelated facts.";

              return `<p style="font-size:22px;">The next deck offered is 
                        <span style="color:${color}; font-weight:bold;">${color.toUpperCase()}</span>.</p>
                      <p>${reminder}</p>
                      <p>If you choose to view, it will cost <b>${cost}Â¢</b>.</p>
                      <p>Would you like to view or wait?</p>`;
            },
            choices: ["View the cards", "Wait"],
            data: { phase: "offer_choice" },
            on_finish: function(data) {
              data.decision = data.response === 0 ? "view" : "wait";
            }
          },

          {
            conditional_function: function() {
              return jsPsych.data.getLastTrialData().values()[0].decision === "view";
            },
            timeline: [
              createImageTrial(`images/causal/causal_series_${seriesIndex}/causal_series_${seriesIndex}_b.png`, "view_card_b", 6000),
              createImageTrial(`images/causal/causal_series_${seriesIndex}/causal_series_${seriesIndex}_c.png`, "view_card_c", 6000)
            ]
          },

          {
            conditional_function: function() {
              return jsPsych.data.getLastTrialData().values()[0].decision === "wait";
            },
            timeline: [
              {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<p style="font-size:22px;">Waiting...</p>`,
                choices: "NO_KEYS",
                trial_duration: 6000,
                data: { phase: "wait_screen" }
              }
            ]
          },

          {
            type: jsPsychSurveyLikert,
            questions: [
              {
                prompt: "How surprising did you find this experience?",
                labels: ["1 - Not at all", "2", "3", "4", "5 - Extremely surprising"],
                required: true
              }
            ],
            data: { phase: "surprise_rating" }
          },
          {
            type: jsPsychSurveyLikert,
            questions: [
              {
                prompt: "How much did you enjoy this part of the task?",
                labels: ["1 - Not at all", "2", "3", "4", "5 - Very much"],
                required: true
              }
            ],
            data: { phase: "enjoyment_rating" }
          }
        ]
      };
    }

    // ====================================================
    // RANDOMIZED BLOCKS
    // ====================================================
    var blocks = [];
    for (let i = 1; i <= 10; i++) {
      blocks.push(createDeckTrial(i));
    }
    timeline.push(...jsPsych.randomization.shuffle(blocks));

    // ====================================================
    // POST QUESTIONS + DEMOGRAPHICS
    // ====================================================
    timeline.push(
      { type: jsPsychSurveyText, questions: [{ prompt: 'Can you describe the difference between the two decks?' }] },
      { type: jsPsychHtmlButtonResponse, stimulus: 'Which color deck showed facts that built on each other?', choices: ['Blue', 'Red'] },
      { type: jsPsychHtmlButtonResponse, stimulus: 'Which color deck showed unrelated facts?', choices: ['Blue', 'Red'] },
      { type: jsPsychHtmlButtonResponse, stimulus: 'Which type of deck did you prefer overall?', choices: ['Red deck', 'Blue deck'] },
      { type: jsPsychSurveyText, questions: [{ prompt: 'Why did you prefer that type of deck?' }] },
      { type: jsPsychSurveyText, questions: [{ prompt: 'Gender (MALE / FEMALE / OTHER)' }, { prompt: 'Age' }] }
    );

    // ====================================================
    // END SCREEN
    // ====================================================
    timeline.push({
      type: jsPsychInstructions,
      pages: [
        '<span style="color:black; font-size:24px;">You have completed the experiment.<br/>The completion code is: 85B28EDEFF<br/>Thank you for your participation!</span>'
      ],
      show_clickable_nav: true
    });

    // ====================================================
    // RUN
    // ====================================================
    jsPsych.run(timeline);
  </script>
</html>
