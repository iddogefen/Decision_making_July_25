<!DOCTYPE html>
<html>
  <head>
    <title>Information Value Task</title>
    <script src="jspsych/plugins/jspsych.js"></script>
    <script src="jspsych/plugins/plugin-instructions.js"></script>
    <script src="jspsych/plugins/plugin-html-button-response.js"></script>
    <script src="jspsych/plugins/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/plugin-survey-likert.js"></script>
    <script src="jspsych/plugins/plugin-fullscreen.js"></script>
    <script src="jspsych/plugins/plugin-preload.js"></script>
    <script src="jspsych/plugins/plugin-survey-text.js"></script>
    <link rel="stylesheet" href="jspsych/css/jspsych.css">
  </head>
  <body></body>

  <script>
    // ====================================================
    // BASIC SETUP
    // ====================================================
    var jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

    var timeline = [];

    // ====================================================
    // CONSENT & INSTRUCTIONS
    // ====================================================

    var preload = {
      type: jsPsychPreload,
      images: ['consent_form_2022.png']
    };
    timeline.push(preload);

    var trial_intro = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-family:Arial; text-align:left; padding:80px;">' +
        '<h2>Welcome!</h2>' +
        '<p>Thank you for participating in this study. You will make decisions about whether to view or wait for pieces of information.</p>' +
        '<p>Press "Next" to continue.</p></div>'
      ],
      show_clickable_nav: true
    };

    var trial_consent = {
      type: jsPsychInstructions,
      pages: [
        '<div style="text-align:center;">' +
        '<h3>Please read the consent form carefully before proceeding.</h3>' +
        '<img src="consent_form_2022.png" style="max-width:80%; padding:20px;"></img>' +
        '</div>'
      ],
      show_clickable_nav: true
    };

    var trial_fullscreen = {
      type: jsPsychFullscreen,
      fullscreen_mode: true
    };

    var instructions_main = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-family:Arial; text-align:left; padding:100px;">' +
        '<h2>Instructions</h2>' +
        '<p>In each round, you will first see an initial card showing an interesting fact.</p>' +
        '<p>Then, one of two decks will be <b>randomly offered</b> (50/50 chance):</p>' +
        '<ul>' +
        '<li><span style="color:blue;">Blue deck</span>: shows <b>two related facts</b> (<b>b</b> and then <b>c</b>) that are connected to the first card you saw.</li>' +
        '<li><span style="color:red;">Red deck</span>: shows <b>two unrelated facts</b> - interesting but taken from different, unconnected topics.</li>' +
        '</ul>' +
        '<p>If you choose to <b>view</b> the cards, you will <b>lose a small random amount of money</b>: either 1, 3, or 5 cents.</p>' +
        '<p>If you choose to <b>wait</b>, you will see a waiting screen for the same duration, but you will <b>not lose money</b>.</p>' +
        '<p>The total duration of each round is identical, whether you choose to view or wait.</p>' +
        '<p>You will receive a <b>$1 bonus</b> for completing the experiment. Any amount you decide to spend to view information will be <b>subtracted from this bonus</b>.</p>' +
        '<p>Follow your curiosity and decide intuitively whether each piece of information is worth the small cost.</p>' +
        '</div>'
      ],
      show_clickable_nav: true
    };

    timeline.push(trial_intro, trial_consent, trial_fullscreen, instructions_main);

    // ====================================================
    // HELPER FUNCTION
    // ====================================================
    function createImageTrial(imagePath, label, duration = 6000) {
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div style="display:flex;justify-content:center;align-items:center;">
                     <img src="${imagePath}" style="width:300px;height:300px;">
                   </div>`,
        choices: "NO_KEYS",
        trial_duration: duration,
        data: { phase: label }
      };
    }

    // ====================================================
    // MAIN TRIAL FUNCTION
    // ====================================================
    function createDeckTrial(seriesIndex) {
      return {
        timeline: [
          createImageTrial(`images/causal/causal_series_${seriesIndex}/causal_series_${seriesIndex}_a.png`, 'start', 6000),

          {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
              const color = jsPsych.randomization.sampleWithoutReplacement(["red", "blue"], 1)[0];
              jsPsych.data.addProperties({ offered_color: color });

              const cost = jsPsych.randomization.sampleWithoutReplacement([1, 3, 5], 1)[0];
              jsPsych.data.addProperties({ view_cost: cost });

              const reminder = color === "blue"
                ? "The blue deck shows two related facts connected to the first card."
                : "The red deck shows two unrelated facts from different topics.";

              return `<p style="font-size:22px;">The next deck offered is 
                        <span style="color:${color}; font-weight:bold;">${color.toUpperCase()}</span>.</p>
                      <p>${reminder}</p>
                      <p>If you choose to <b>view</b>, it will cost <b>${cost}Â¢</b>.</p>
                      <p>Would you like to <b>view</b> or <b>wait</b> for the same duration?</p>`;
            },
            choices: ["View the cards", "Wait"],
            data: { phase: "offer_choice" },
            on_finish: function(data) {
              data.decision = data.response === 0 ? "view" : "wait";
            }
          },

          {
            conditional_function: function() {
              return jsPsych.data.getLastTrialData().values()[0].decision === "view";
            },
            timeline: [
              {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function() {
                  const color = jsPsych.data.get().last(2).values()[0].offered_color;
                  const series = seriesIndex;

                  if (color === "blue") {
                    return `<div style="display:flex;justify-content:center;">
                              <img src="images/causal/causal_series_${series}/causal_series_${series}_b.png" style="width:300px;height:300px;">
                            </div>`;
                  } else {
                    const otherSeries = jsPsych.randomization.sampleWithoutReplacement(
                      Array.from({ length: 10 }, (_, i) => i + 1).filter(n => n !== series),
                      1
                    )[0];
                    const letter = jsPsych.randomization.sampleWithoutReplacement(['b','c'],1)[0];
                    return `<div style="display:flex;justify-content:center;">
                              <img src="images/causal/causal_series_${otherSeries}/causal_series_${otherSeries}_${letter}.png" style="width:300px;height:300px;">
                            </div>`;
                  }
                },
                choices: "NO_KEYS",
                trial_duration: 6000,
                data: { phase: "view_card_b" }
              },
              {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function() {
                  const color = jsPsych.data.get().last(3).values()[0].offered_color;
                  const series = seriesIndex;
                  if (color === "blue") {
                    return `<div style="display:flex;justify-content:center;">
                              <img src="images/causal/causal_series_${series}/causal_series_${series}_c.png" style="width:300px;height:300px;">
                            </div>`;
                  } else {
                    const otherSeries = jsPsych.randomization.sampleWithoutReplacement(
                      Array.from({ length: 10 }, (_, i) => i + 1).filter(n => n !== series),
                      1
                    )[0];
                    const letter = jsPsych.randomization.sampleWithoutReplacement(['b','c'],1)[0];
                    return `<div style="display:flex;justify-content:center;">
                              <img src="images/causal/causal_series_${otherSeries}/causal_series_${otherSeries}_${letter}.png" style="width:300px;height:300px;">
                            </div>`;
                  }
                },
                choices: "NO_KEYS",
                trial_duration: 6000,
                data: { phase: "view_card_c" }
              }
            ]
          },

          {
            conditional_function: function() {
              return jsPsych.data.getLastTrialData().values()[0].decision === "wait";
            },
            timeline: [
              {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<p style="font-size:22px;">Waiting...</p>`,
                choices: "NO_KEYS",
                trial_duration: 6000,
                data: { phase: "wait_screen" }
              }
            ]
          },

          {
            type: jsPsychSurveyLikert,
            questions: [
              {
                prompt: "How surprising did you find this experience?",
                labels: ["1 - Not at all", "2", "3", "4", "5 - Extremely surprising"],
                required: true
              }
            ],
            data: { phase: "surprise_rating" }
          },
          {
            type: jsPsychSurveyLikert,
            questions: [
              {
                prompt: "How much did you enjoy this part of the task?",
                labels: ["1 - Not at all", "2", "3", "4", "5 - Very much"],
                required: true
              }
            ],
            data: { phase: "enjoyment_rating" }
          }
        ]
      };
    }

    // ====================================================
    // RANDOMIZED BLOCKS
    // ====================================================
    var blocks = [];
    for (let i = 1; i <= 10; i++) {
      blocks.push(createDeckTrial(i));
    }
    blocks = jsPsych.randomization.shuffle(blocks);
    timeline.push(...blocks);

    // ====================================================
    // POST QUESTIONS
    // ====================================================
    var trial_difference_between_decks = {
      type: jsPsychSurveyText,
      questions: [{ prompt: 'Can you describe the difference between the two decks of cards?' }]
    };

    var trial_deck_color = {
      type: jsPsychHtmlButtonResponse,
      stimulus: 'Which color deck showed facts that built on each other?',
      choices: ['Blue', 'Red']
    };

    var trial_deck_color_not_following = {
      type: jsPsychHtmlButtonResponse,
      stimulus: 'Which color deck showed unrelated facts?',
      choices: ['Blue', 'Red']
    };

    var trial_deck_preference = {
      type: jsPsychHtmlButtonResponse,
      stimulus: 'Which type of deck did you prefer overall?',
      choices: [
        'The red deck, which showed unrelated facts',
        'The blue deck, which showed facts that built on each other'
      ]
    };

    var trial_deck_preference_reason = {
      type: jsPsychSurveyText,
      questions: [
        { prompt: 'Why did you prefer that type of deck?' }
      ]
    };

    timeline.push(
      trial_difference_between_decks,
      trial_deck_color,
      trial_deck_color_not_following,
      trial_deck_preference,
      trial_deck_preference_reason
    );

    // ====================================================
    // DEMOGRAPHICS
    // ====================================================
    var trial_101 = {
      type: jsPsychSurveyText,
      questions: [
        { prompt: 'Please insert your gender (MALE / FEMALE / OTHER)' },
        { prompt: 'Please insert your age' }
      ]
    };
    timeline.push(trial_101);

    // ====================================================
    // END SCREEN
    // ====================================================
    var trial_102 = {
      type: jsPsychInstructions,
      pages: [
        '<span style="color: black; font-size: 24px">You have completed the experiment.' +
        '<br/>The completion code is : 85B28EDEFF <br/>Thank you for your participation!</span>'
      ],
      show_clickable_nav: true
    };
    timeline.push(trial_102);

    // ====================================================
    // RUN EXPERIMENT
    // ====================================================
    jsPsych.run(timeline);
  </script>
</html>
