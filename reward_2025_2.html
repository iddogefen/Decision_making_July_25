<!DOCTYPE html>
<html>
  <head>
    <title>Information Value Task - Time Version (100 Seconds)</title>
    <script src="jspsych/plugins/jspsych.js"></script>
    <script src="jspsych/plugins/plugin-instructions.js"></script>
    <script src="jspsych/plugins/plugin-html-button-response.js"></script>
    <script src="jspsych/plugins/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/plugin-survey-likert.js"></script>
    <script src="jspsych/plugins/plugin-fullscreen.js"></script>
    <script src="jspsych/plugins/plugin-preload.js"></script>
    <script src="jspsych/plugins/plugin-survey-text.js"></script>
    <link rel="stylesheet" href="jspsych/css/jspsych.css">
  </head>
  <body></body>

  <script>
    // ====================================================
    // SAVE FUNCTION
    // ====================================================
    var data_folder = 'data/';

    function saveData(name, data) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'write_data.php');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify({ filedata: data }));
    }

    // ====================================================
    // INIT JPSYCH
    // ====================================================
    var jsPsych = initJsPsych({
      on_finish: function() {
        saveData(
          data_folder + 'All_data/all_data_sub_' + subject_id + ".csv",
          jsPsych.data.get().csv()
        );
      }
    });

    // ====================================================
    // SUBJECT PROPERTIES
    // ====================================================
    var subject_id = jsPsych.data.getURLVariable('participantId') || "anon_" + Math.floor(Math.random()*100000);
    var study_id   = jsPsych.data.getURLVariable('assignmentId') || "none";
    var session_id = jsPsych.data.getURLVariable('projectId') || "session_" + Date.now();

    jsPsych.data.addProperties({
      subject_id: subject_id,
      study_id: study_id,
      session_id: session_id,
    });

    // ====================================================
    // TIMELINE START
    // ====================================================
    var timeline = [];
    var EXPERIMENT_DURATION = 100000; // 100 seconds total
    var start_time;

    // ====================================================
    // PRELOAD
    // ====================================================
    var preload = {
      type: jsPsychPreload,
      images: [
        'consent_form_2022.png',
        'images/blue_deck_1.png',
        'images/red_deck_2.png'
      ]
    };
    timeline.push(preload);

    // ====================================================
    // CONSENT & INSTRUCTIONS
    // ====================================================
    var trial_intro = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-family:Arial; text-align:left; padding:80px;">' +
        '<h2>Welcome!</h2>' +
        '<p>Thank you for participating in this study. You will make decisions about how long to wait to view pieces of information.</p>' +
        '<p>Press "Next" to continue.</p></div>'
      ],
      show_clickable_nav: true
    };

    var trial_consent = {
      type: jsPsychInstructions,
      pages: [
        '<div style="text-align:center;">' +
        '<h3>Please read the consent form carefully before proceeding.</h3>' +
        '<img src="consent_form_2022.png" style="max-width:80%; padding:20px;"></img>' +
        '</div>'
      ],
      show_clickable_nav: true
    };

    var trial_fullscreen = { type: jsPsychFullscreen, fullscreen_mode: true };

    var instructions_part1 = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-family:Arial; text-align:left; padding:100px;">' +
        '<h2>Instructions (1/2)</h2>' +
        '<p>In this experiment, you will decide how long you are willing to wait to see additional information.</p>' +
        '<p>Each round begins with an initial event, followed by an offer from one of two series:</p>' +
        '<ul>' +
        '<li><span style="color:blue;">Blue series</span>: shows events that have a <b>cause and effect</b> relationship (each action leads to a result).</li>' +
        '<li><span style="color:red;">Red series</span>: shows events that have a <b>cause without an effect</b> (situations that do not lead anywhere).</li>' +
        '</ul>' +
        '<p>If you choose to <b>view</b>, you will wait for a short period (4, 8, or 12 seconds) before seeing the next images.</p>' +
        '<p>If you choose to <b>skip</b>, you will move immediately to the next round.</p>' +
        '</div>'
      ],
      show_clickable_nav: true
    };

    var instructions_part2 = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-family:Arial; text-align:left; padding:100px;">' +
        '<h2>Instructions (2/2)</h2>' +
        '<p style="font-size:20px;"><b>The total duration of this experiment will always be 100 seconds (1 minute and 40 seconds).</b></p>' +
        '<p style="font-size:20px;"><b>No matter what you choose, to wait or to skip, the total time will remain the same.</b></p>' +
        '<p style="font-size:20px;"><b>Please follow your curiosity and choose what genuinely interests you.</b></p>' +
        '<p>Click “Next” to begin.</p>' +
        '</div>'
      ],
      show_clickable_nav: true,
      on_finish: function() { start_time = performance.now(); }
    };

    timeline.push(trial_intro, trial_consent, trial_fullscreen, instructions_part1, instructions_part2);

    // ====================================================
    // DEFINE ALL COMBINATIONS (BALANCED)
    // ====================================================
    const all_combinations = jsPsych.randomization.repeat(
      [
        {color: "blue", wait: 4000},
        {color: "blue", wait: 8000},
        {color: "blue", wait: 12000},
        {color: "red", wait: 4000},
        {color: "red", wait: 8000},
        {color: "red", wait: 12000}
      ],
      10
    );

    const randomized_combinations = jsPsych.randomization.shuffle(all_combinations);
    let combo_index = 0;

    // ====================================================
    // IMAGE TRIAL WITH CARRYOVER DATA
    // ====================================================
    function createImageTrial(imagePath, label, duration = 4000) {
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div style="display:flex;justify-content:center;align-items:center;">
                     <img src="${imagePath}" style="width:300px;height:300px;">
                   </div>`,
        choices: "NO_KEYS",
        trial_duration: duration,
        data: function() {
          const last = jsPsych.data.getLastTrialData().values()[0] || {};
          return {
            phase: label,
            offered_color: last.offered_color || "none",
            wait_time: last.wait_time || duration
          };
        }
      };
    }

    // ====================================================
    // MAIN TRIAL FUNCTION
    // ====================================================
    function createDeckTrial(seriesIndex) {
      return {
        timeline: [
          createImageTrial(`images/causal/causal_series_${seriesIndex}/causal_series_${seriesIndex}_a.png`, 'start', 4000),

          {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
              const thisTrial = randomized_combinations[combo_index];
              combo_index++;
              const color = thisTrial.color;
              const waitTime = thisTrial.wait;
              const reminder = color === "blue"
                ? "The blue series shows an event that has a cause and an effect."
                : "The red series shows an event that has a cause but no clear effect.";
              return `<p style="font-size:22px;">The next series offered is 
                        <span style="color:${color}; font-weight:bold;">${color.toUpperCase()}</span>.</p>
                      <p>${reminder}</p>
                      <p>If you choose to view, you will need to wait <b>${waitTime / 1000} seconds</b> before seeing the next images.</p>
                      <p>Would you like to view or skip?</p>`;
            },
            choices: ["View (wait)", "Skip"],
            data: function() {
              const thisTrial = randomized_combinations[combo_index - 1];
              return {
                phase: "offer_choice",
                offered_color: thisTrial.color,
                wait_time: thisTrial.wait
              };
            },
            on_finish: function(data) {
              data.decision = data.response === 0 ? "view" : "skip";
            }
          },

          // ====== WAIT SCREEN ======
          {
            conditional_function: function() {
              return jsPsych.data.getLastTrialData().values()[0].decision === "view";
            },
            timeline: [
              {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function() {
                  const last = jsPsych.data.getLastTrialData().values()[0];
                  const waitSecs = last.wait_time / 1000;
                  return `<p style="font-size:22px;">Please wait <b>${waitSecs}</b> seconds...</p>`;
                },
                choices: "NO_KEYS",
                trial_duration: function() {
                  return jsPsych.data.getLastTrialData().values()[0].wait_time;
                },
                data: function() {
                  const last = jsPsych.data.getLastTrialData().values()[0];
                  return {
                    phase: "waiting_screen",
                    offered_color: last.offered_color,
                    wait_time: last.wait_time
                  };
                }
              }
            ]
          },

          // ====== BLUE (causal) ======
          {
            conditional_function: function() {
              const last = jsPsych.data.getLastTrialData().values()[0];
              return last.decision === "view" && last.offered_color === "blue";
            },
            timeline: [
              createImageTrial(`images/causal/causal_series_${seriesIndex}/causal_series_${seriesIndex}_b.png`, "view_card_b"),
              createImageTrial(`images/causal/causal_series_${seriesIndex}/causal_series_${seriesIndex}_c.png`, "view_card_c")
            ]
          },

          // ====== RED (non-causal) ======
          {
            conditional_function: function() {
              const last = jsPsych.data.getLastTrialData().values()[0];
              return last.decision === "view" && last.offered_color === "red";
            },
            timeline: (function() {
              const otherSeries = Array.from({ length: 10 }, (_, i) => i + 1).filter(i => i !== seriesIndex);
              const randomSeries = jsPsych.randomization.sampleWithoutReplacement(otherSeries, 2);
              const firstCard = jsPsych.randomization.sampleWithoutReplacement(["b", "c"], 1)[0];
              const secondCard = jsPsych.randomization.sampleWithoutReplacement(["b", "c"], 1)[0];
              return [
                createImageTrial(`images/causal/causal_series_${randomSeries[0]}/causal_series_${randomSeries[0]}_${firstCard}.png`, "random_card_1"),
                createImageTrial(`images/causal/causal_series_${randomSeries[1]}/causal_series_${randomSeries[1]}_${secondCard}.png`, "random_card_2")
              ];
            })()
          },

          // ====== SKIP ======
          {
            conditional_function: function() {
              return jsPsych.data.getLastTrialData().values()[0].decision === "skip";
            },
            timeline: [
              {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<p style="font-size:22px;">Skipping to the next round...</p>`,
                choices: "NO_KEYS",
                trial_duration: 2000,
                data: function() {
                  const last = jsPsych.data.getLastTrialData().values()[0];
                  return {
                    phase: "skip_screen",
                    offered_color: last.offered_color,
                    wait_time: last.wait_time
                  };
                }
              }
            ]
          }
        ]
      };
    }

    // ====================================================
    // EXPERIMENT LOOP
    // ====================================================
    var main_loop = {
      timeline: [],
      loop_function: function() {
        var elapsed = performance.now() - start_time;
        return elapsed < EXPERIMENT_DURATION;
      }
    };

    var blocks = [];
    for (let i = 1; i <= 10; i++) {
      blocks.push(createDeckTrial(i));
    }
    main_loop.timeline = jsPsych.randomization.shuffle(blocks);
    timeline.push(main_loop);

    // ====================================================
    // END-OF-TIME SCREEN
    // ====================================================
    var end_of_time_screen = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus:
        `<div style="text-align:center; font-size:28px; font-family:Arial; padding:60px;">
          <p>The 100 seconds are now over.</p>
          <p>Please take a moment before continuing to the final questions.</p>
        </div>`,
      choices: "NO_KEYS",
      trial_duration: 4000,
      data: { phase: "end_of_time" }
    };

    timeline.push(end_of_time_screen);

    // ====================================================
    // POST QUESTIONS
    // ====================================================
    timeline.push(
      {
        type: jsPsychSurveyText,
        questions: [{ prompt: 'Can you describe the difference between the two decks?' }]
      },
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: 'Which color deck showed facts that built on each other?',
        choices: ['Blue', 'Red']
      },
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: 'Which color deck showed unrelated facts?',
        choices: ['Blue', 'Red']
      },
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: 'Which type of deck did you prefer overall?',
        choices: ['Red deck', 'Blue deck']
      },
      {
        type: jsPsychSurveyText,
        questions: [{ prompt: 'Why did you prefer that type of deck?' }]
      },
      {
        type: jsPsychSurveyText,
        questions: [
          { prompt: 'Gender (MALE / FEMALE / OTHER)' },
          { prompt: 'Age' }
        ]
      }
    );

    // ====================================================
    // END SCREEN
    // ====================================================
    timeline.push({
      type: jsPsychInstructions,
      pages: [
        '<span style="color:black; font-size:24px;">You have completed the experiment.<br/>Completion code: <b>85B28EDEFF</b><br/>Thank you for your participation!</span>'
      ],
      show_clickable_nav: true
    });

    // ====================================================
    // RUN
    // ====================================================
    jsPsych.run(timeline);
  </script>
</html>
